Sub ExtractAndSort()

    ' 変数を宣言
    Dim SourceSheet As Worksheet
    Dim DestinationSheet As Worksheet
    Dim i As Long, j As Long, lastRow As Long, lastColumn As Long, targetDateColumn As Long
    Dim rowCount As Long
    Dim targetDate As Date

    ' シフト表シートと出勤者リストシートを設定
    Set SourceSheet = ThisWorkbook.Worksheets("シフト表")
    Set DestinationSheet = ThisWorkbook.Worksheets("出勤者リスト")

    ' シフト表シートの最後の行と最後の列を取得
    lastRow = SourceSheet.Cells(SourceSheet.Rows.Count, 2).End(xlUp).Row
    lastColumn = SourceSheet.Cells(1, SourceSheet.Columns.Count).End(xlToLeft).Column

    ' 出勤者リストシートをクリア
    DestinationSheet.Cells.Clear

    ' 日付ごとに横に並べて出力
    For j = 3 To lastColumn
        targetDate = SourceSheet.Cells(1, j).Value
        DestinationSheet.Cells(1, (j - 2) * 2).Value = targetDate

        ' 対象日の出勤者の名前と勤怠を抽出
        rowCount = 1
        For i = 2 To lastRow
            If IsNumeric(SourceSheet.Cells(i, j)) Then
                rowCount = rowCount + 1
                DestinationSheet.Cells(rowCount, (j - 2) * 2).Value = SourceSheet.Cells(i, 2).Value
                DestinationSheet.Cells(rowCount, (j - 2) * 2 + 1).Value = SourceSheet.Cells(i, j).Value
            End If
        Next i
    Next j

End Sub


--
Function GetWorkbook(ByVal workbookName As String) As Workbook
    Dim wb As Workbook

    On Error Resume Next
    Set wb = Workbooks(workbookName)
    On Error GoTo 0

    If wb Is Nothing Then
        Set wb = Workbooks.Open(workbookName, ReadOnly:=True)
    End If

    Set GetWorkbook = wb
End Function

Sub ExtractShifts()
    ' 変数を宣言
    Dim sourceWorkbook As Workbook
    Dim sourceWorkbookName As String
    Dim targetWorkbook As Workbook
    Dim targetWorkbookName As String
    Dim sourceWorksheet As Worksheet
    Dim targetWorksheet As Worksheet
    Dim settingsWorksheet As Worksheet
    Dim lastRow As Long
    Dim targetRow As Long
    Dim lastSettingsRow As Long
    Dim nameFilter() As Variant
    Dim name As Variant
    Dim i As Long
    
    ' ワークブック名を設定
    sourceWorkbookName = "jj.xlsx"
    targetWorkbookName = "ExtractShifts.xlsm"
    
    GetWorkbook (sourceWorkbookName)
    
    ' ソースブックとターゲットブックを設定
    Set sourceWorkbook = Workbooks(sourceWorkbookName)
    Set targetWorkbook = Workbooks(targetWorkbookName)
    Set sourceWorksheet = sourceWorkbook.Worksheets("Sheet2")
    Set targetWorksheet = targetWorkbook.Worksheets("シフト表")
    Set settingsWorksheet = targetWorkbook.Worksheets("設定")

    ' 設定シートから名前フィルタの配列を作成
    lastSettingsRow = settingsWorksheet.Cells(settingsWorksheet.Rows.Count, "A").End(xlUp).Row
    ReDim nameFilter(1 To lastSettingsRow)
    For i = 2 To lastSettingsRow
        nameFilter(i) = settingsWorksheet.Cells(i, 1).Value
    Next i
    
    ' ターゲットシートの内容をクリア
    targetWorksheet.Cells.Clear
    
    ' ソースシートのヘッダー行をコピー
    sourceWorksheet.Rows(1).Copy targetWorksheet.Rows(1)
    
    ' ターゲットシートの最後の行を取得
    targetRow = targetWorksheet.Cells(targetWorksheet.Rows.Count, "A").End(xlUp).Row + 1

    ' ソースシートの最後の行を取得
    lastRow = sourceWorksheet.Cells(sourceWorksheet.Rows.Count, "A").End(xlUp).Row

    ' ソースシートの各行をループ
    For i = 2 To lastRow
        ' 名前フィルターをループ
        For Each name In nameFilter
            ' 名前がフィルターと一致する場合
            If sourceWorksheet.Cells(i, 2).Value = name Then
                ' 行全体をコピー
                sourceWorksheet.Rows(i).Copy targetWorksheet.Rows(targetRow)

                ' ターゲットシートの次の行に移動
                targetRow = targetRow + 1
                Exit For
            End If
        Next name
    Next i
End Sub

